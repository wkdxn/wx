<link rel="preconnect" href="https://github.githubassets.com">
<link rel="dns-prefetch" href="https://github.githubassets.com">
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信好友添加</title>
    <style>
        /* ===== 全局重置 ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, system-ui, sans-serif;
            padding: 20px;
        }

        /* ===== 容器样式 ===== */
        .container {
            max-width: 600px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        /* ===== 二维码卡片 ===== */
        .qr-card {
            background: #fff;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            margin: 0 auto;
        }

        /* ===== 二维码图片 ===== */
        .qr-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            margin: 1.5rem 0;
            border-radius: 12px;
            -webkit-touch-callout: none;
        }

        /* ===== 操作指引 ===== */
        .guide-text {
            color: #666;
            font-size: 0.95rem;
            margin: 1.5rem 0;
            line-height: 1.6;
        }

        /* ===== 微信环境提示 ===== */
        .wechat-tip {
            color: #e55039;
            padding: 1rem;
            border-radius: 8px;
            background: #ffeeed;
            margin: 1rem 0;
        }

        /* ===== 响应式设计 ===== */
        @media (max-width: 480px) {
            .qr-card {
                padding: 1.5rem;
                border-radius: 16px;
            }
            .qr-image {
                max-width: 280px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="qr-card">
            <!-- 微信环境提示 -->
            <div class="wechat-tip" id="wechatTip" style="display:none;">
                请长按二维码保存后，在微信中使用扫一扫功能
            </div>

            <!-- 二维码显示区域 -->
            <h1>添加微信好友</h1>
            <img src="./images/wxtp.jpg" 
                 class="qr-image"
                 alt="微信二维码"
                 loading="eager"
                 oncontextmenu="return false"
                 onerror="handleImageError(this)">

            <!-- 操作指引 -->
            <div class="guide-text" id="actionGuide">
                <p>正在尝试跳转微信...</p>
            </div>
        </div>
    </div>

    <script>
        // ===== 配置参数 =====
        const CONFIG = {
            wechatScheme: 'weixin://dl/add?username=wkdmq258', // 替换真实微信号
            fallbackDelay: 1500,  // 跳转失败等待时间
            maxRetry: 2           // 最大重试次数
        };

        // ===== 环境检测 =====
        const isWechat = /MicroMessenger/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        let retryCount = 0;

        // ===== 核心跳转逻辑 =====
        function redirectToWechat() {
            if (isWechat) {
                showWechatTip();
                return;
            }

            if (retryCount >= CONFIG.maxRetry) {
                showFallbackGuide();
                return;
            }

            retryCount++;
            
            // 创建隐藏iframe实现跳转
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = CONFIG.wechatScheme;
            document.body.appendChild(iframe);

            // 跳转结果检测
            setTimeout(() => {
                if (!document.hidden) {
                    showFallbackGuide();
                }
                document.body.removeChild(iframe);
            }, CONFIG.fallbackDelay);
        }

        // ===== 微信环境处理 =====
        function showWechatTip() {
            document.getElementById('wechatTip').style.display = 'block';
            document.getElementById('actionGuide').innerHTML = `
                <p>操作步骤：</p>
                <p>1. 长按保存二维码</p>
                <p>2. 退出当前页面</p>
                <p>3. 打开微信扫一扫 → 从相册选择</p>
            `;
        }

        // ===== 跳转失败处理 =====
        function showFallbackGuide() {
            document.getElementById('actionGuide').innerHTML = `
                <p style="color:#e55039;">跳转失败，请选择：</p>
                <button onclick="redirectToWechat()" 
                    style="background:#07c160; color:white; border:none; padding:12px 24px; border-radius:24px; margin:8px; cursor:pointer;">
                    重试跳转
                </button>
                <button onclick="showSaveTip()" 
                    style="background:#2d3436; color:white; border:none; padding:12px 24px; border-radius:24px; margin:8px; cursor:pointer;">
                    保存二维码
                </button>
            `;
        }

        // ===== 图片异常处理 =====
        function handleImageError(img) {
            console.error('二维码加载失败:', img.src);
            img.style.display = 'none';
            document.getElementById('wechatTip').style.display = 'block';
            document.getElementById('wechatTip').innerHTML = '资源加载失败，请刷新页面';
        }

        // ===== 保存提示 =====
        function showSaveTip() {
            alert('请长按二维码图片选择「保存到手机相册」');
        }

        // ===== 初始化执行 =====
        if (isWechat) {
            showWechatTip();
        } else {
            // iOS需要用户交互才能跳转
            if (isIOS) {
                document.getElementById('actionGuide').innerHTML = `
                    <button onclick="redirectToWechat()" 
                        style="background:#07c160; color:white; border:none; padding:12px 36px; border-radius:28px; margin:8px; cursor:pointer;">
                        点击跳转微信
                    </button>
                `;
            } else {
                redirectToWechat();
            }
        }

        // ===== 防止iOS长按菜单 =====
        document.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('qr-image')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
